```c++

#pragma once
#include <Windows.h>
#include <qwidget.h>
#include <QtWin>
#include <dwmapi.h>
#include <QPushButton>
#include <QPainter>
#include <QVariant>

class CAwMainWindow;
class QBoxLayout;
class QToolButton;
class QLabel;
class QMenuBar;
class CAwTitleBar;

#ifndef AWFRAME_WIDGET_MAXSIZE_PROPERTY
    #define AWFRAME_MAXSIZE_PROPERTY ("IS_MAX_SIZE")
#else
    #error AWFRAME_WIDGET_MAXSIZE_PROPERTY declared repeatedly
#endif // !AWFRAME_WIDGET_MAXSIZE_PROPERTY

#ifndef AWFRAME_WIDGET_BORDER_WIDTH
#define AWFRAME_WIDGET_BORDER_WIDTH (5)
#else
#error AWFRAME_WIDGET_BORDER_WIDTH declared repeatedly
#endif // !AWFRAME_WIDGET_BORDER_WIDTH

#ifndef AWFRAME_WIDGET_BORDER_LINE_WIDTH
#define AWFRAME_WIDGET_BORDER_LINE_WIDTH (1)
#else
#error AWFRAME_WIDGET_BORDER__LINE_WIDTH declared repeatedly
#endif // !AWFRAME_WIDGET_BORDER__LINE_WIDTH

#ifndef AWFRAME_WIDGET_BORDER_COLOR
#define AWFRAME_WIDGET_BORDER_COLOR (QColor("#067dca"))
#else
#error AWFRAME_WIDGET_BORDER_COLOR declared repeatedly
#endif // !AWFRAME_WIDGET_BORDER_COLOR

#ifndef AWFRAME_WIDGET_CONTENTS_MARGIN
    #define AWFRAME_WIDGET_CONTENTS_MARGIN (QMargins(1, 1, 1, 1))
#else
    #error AWFRAME_WIDGET_CONTENTS_MARGIN declared repeatedly
#endif // !AWFRAME_WIDGET_CONTENTS_MARGIN

#ifndef AW_FRAME_WIDGET
    #define AW_FRAME_WIDGET \
public: \
    void setWindowTitle(const QString &window_title) {                                        \
        if (m_p_title_bar != nullptr) {                                                       \
            m_p_title_bar->set_window_title(window_title);                                    \
        }                                                                                     \
        QWidget::setWindowTitle(window_title);                                                \
    }                                                                                         \
    void setWindowIcon(const QIcon &icon)                                                     \
    {                                                                                         \
        if (m_p_title_bar != nullptr) {                                                       \
            m_p_title_bar->set_window_icon(icon);                                             \
        }                                                                                     \
        QWidget::setWindowIcon(icon);                                                         \
    }                                                                                         \
    void setIconSize(const QSize &size)                                                       \
    {                                                                                         \
        if (m_p_title_bar != nullptr) {                                                       \
            m_p_title_bar->set_icon_size(size);                                               \
        }                                                                                     \
    }                                                                                         \
    bool isMaximized() const                                                                  \
    {                                                                                         \
        return m_maximum_size_flag;                                                           \
    }                                                                                         \
    void setFixedWidth(qint32 width)                                                          \
    {                                                                                         \
        QWidget::setFixedWidth(width);                                                        \
        remove_window_thickframe();                                                           \
    }                                                                                         \
    void setFixedHeight(qint32 height)                                                        \
    {                                                                                         \
        QWidget::setFixedHeight(height);                                                      \
        remove_window_thickframe();                                                           \
    }                                                                                         \
    void setFixedSize(QSize size)                                                             \
    {                                                                                         \
        QWidget::setFixedSize(size);                                                          \
        remove_window_thickframe();                                                           \
    }                                                                                         \
    void setFixedSize(qint32 w, qint32 h)                                                     \
    {                                                                                         \
        setFixedSize(QSize(w, h));                                                            \
    }                                                                                         \
private:                                                                                      \
    CAwTitleBar *m_p_title_bar{new CAwTitleBar(this)};                                        \
    bool m_maximum_size_flag{false};                                                          \
    void set_hwnd_options()                                                                   \
    {                                                                                         \
        setWindowFlag(Qt::FramelessWindowHint);                                               \
        setWindowIcon(QtWin::fromHICON(LoadIcon(NULL, IDI_APPLICATION)));                     \
        setContentsMargins(AWFRAME_WIDGET_CONTENTS_MARGIN);                                   \
        if (QtWin::isCompositionEnabled()) {                                                  \
            HWND hwnd = (HWND)this->winId();                                                  \
            DWORD style = ::GetWindowLong(hwnd, GWL_STYLE);                                   \
            ::SetWindowLong(hwnd, GWL_STYLE, style | WS_THICKFRAME | WS_CAPTION | WS_BORDER); \
            QtWin::extendFrameIntoClientArea(this, 1, 1, 1, 1);                               \
        }                                                                                     \
    }                                                                                         \
    LRESULT calculate_border(const QPoint &pt)                                                \
    {                                                                                         \
        int border_size = AWFRAME_WIDGET_BORDER_WIDTH;                                        \
        int cx = this->size().width();                                                        \
        int cy = this->size().height();                                                       \
        LRESULT ret = HTCLIENT;                                                               \
        QRect rect_top_left(0, 0, border_size, border_size);                                  \
        QRect rect_left(0, border_size, border_size, cy - border_size * 2);                   \
        QRect rect_top_right(cx - border_size, 0, border_size, border_size);                  \
        QRect rect_right(cx - border_size, border_size, border_size, cy - border_size * 2);   \
        QRect rect_top(border_size, 0, cx - border_size * 2, border_size);                    \
        QRect rect_bottom_left(0, cy - border_size, border_size, border_size);                \
        QRect rect_bottom_right(cx - border_size, cy - border_size, border_size, border_size); \
        QRect rect_bottom(border_size, cy - border_size, cx - border_size * 2, border_size);  \
                                                                                              \
        if (::IsZoomed((HWND)this->winId())) {                                                \
            ret = HTCLIENT;                                                                   \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_top_left.contains(pt)) {                                                     \
            ret = HTTOPLEFT;                                                                  \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_left.contains(pt)) {                                                         \
            ret = HTLEFT;                                                                     \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_top_right.contains(pt)) {                                                    \
            ret = HTTOPRIGHT;                                                                 \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_right.contains(pt)) {                                                        \
            ret = HTRIGHT;                                                                    \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_top.contains(pt)) {                                                          \
            ret = HTTOP;                                                                      \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_bottom_left.contains(pt)) {                                                  \
            ret = HTBOTTOMLEFT;                                                               \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_bottom_right.contains(pt)) {                                                 \
            ret = HTBOTTOMRIGHT;                                                              \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_bottom.contains(pt)) {                                                       \
            ret = HTBOTTOM;                                                                   \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
    EXIT:                                                                                     \
        return ret;                                                                           \
    }                                                                                         \
    void remove_window_thickframe()                                                           \
    {                                                                                         \
        HWND hwnd = (HWND)this->winId();                                                      \
        DWORD style = GetWindowLong(hwnd, GWL_STYLE);                                         \
        style &= ~WS_THICKFRAME;                                                              \
        SetWindowLong(hwnd, GWL_STYLE, style);                                                \
        if (m_p_title_bar != nullptr) {                                                       \
            m_p_title_bar->set_maxrestore_btn_enabled(false);                                 \
        }                                                                                     \
    }                                                                                         \
                                                                                              \
protected:                                                                                    \
    bool nativeEvent(const QByteArray &event_type, void *message, long *result)               \
    {                                                                                         \
        bool ret = false;                                                                     \
                                                                                              \
        MSG *msg = static_cast<MSG *>(message);                                               \
        QWidget *p_widget = QWidget::find(reinterpret_cast<WId>(msg->hwnd));                  \
        if (event_type != "windows_generic_MSG") {                                            \
            goto EXIT;                                                                        \
        }                                                                                     \
        if (nullptr == p_widget) {                                                            \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        switch (msg->message) {                                                               \
        case WM_NCCALCSIZE: {                                                                 \
            *result = 0;                                                                      \
            ret = true;                                                                       \
            goto EXIT;                                                                        \
        }                                                                                     \
            break;                                                                            \
                                                                                              \
        case WM_NCHITTEST: {                                                                  \
            qint32 x = (static_cast<qint32>(static_cast<short>(LOWORD(msg->lParam))));        \
            qint32 y = (static_cast<qint32>(static_cast<short>(HIWORD(msg->lParam))));        \
            QPoint pt = mapFromGlobal(QPoint(x, y));                                          \
            *result = calculate_border(pt);                                                   \
            if (*result == HTCLIENT) {                                                        \
                if (m_p_title_bar != nullptr && m_p_title_bar->rect().contains(pt)) {         \
                    QWidget *p_child = m_p_title_bar->childAt(pt);                            \
                    if (m_p_title_bar->check_mouse_pt_on_proxy_widget(p_child)) {             \
                        *result = HTCAPTION;                                                  \
                    }                                                                         \
                }                                                                             \
            }                                                                                 \
            ret = true;                                                                       \
            goto EXIT;                                                                        \
        }                                                                                     \
            break;                                                                            \
                                                                                              \
        case WM_GETMINMAXINFO: {                                                              \
            if (::IsZoomed(msg->hwnd)) {                                                      \
                RECT frame = { 0, 0, 0, 0 };                                                  \
                m_maximum_size_flag = true;                                                   \
                AdjustWindowRectEx(&frame, WS_OVERLAPPEDWINDOW, FALSE, 0);                    \
                frame.left = abs(frame.left);                                                 \
                frame.top = abs(frame.bottom);                                                \
                p_widget->setContentsMargins(frame.left - 1, frame.top - 1,                   \
                                             frame.right, frame.bottom);                      \
            } else {                                                                          \
                p_widget->setContentsMargins(AWFRAME_WIDGET_CONTENTS_MARGIN);                 \
                m_maximum_size_flag = false;                                                  \
            }                                                                                 \
            *result = ::DefWindowProc(msg->hwnd, msg->message, msg->wParam, msg->lParam);     \
            p_widget->setProperty(AWFRAME_MAXSIZE_PROPERTY, QVariant(m_maximum_size_flag));   \
            ret = true;                                                                       \
            goto EXIT;                                                                        \
        }                                                                                     \
            break;                                                                            \
                                                                                              \
        case WM_NCLBUTTONDBLCLK: {                                                            \
            HWND hwnd = (HWND)this->winId();                                                  \
            DWORD style = GetWindowLong(hwnd, GWL_STYLE);                                     \
            ret = !(style & WS_THICKFRAME);                                                   \
            goto EXIT;                                                                        \
        }                                                                                     \
        break;                                                                                \
                                                                                              \
        default:                                                                              \
            break;                                                                            \
        }                                                                                     \
    EXIT:                                                                                     \
        return ret;                                                                           \
    }                                                                                         \
    void paintEvent(QPaintEvent *event)                                                       \
    {                                                                                         \
        Q_UNUSED(event)                                                                       \
        QColor color = AWFRAME_WIDGET_BORDER_COLOR;                                           \
        int border_wd = AWFRAME_WIDGET_BORDER_LINE_WIDTH;                                     \
        int w = width();                                                                      \
        int h = height();                                                                     \
        QPainter painter(this);                                                               \
                                                                                              \
        if (!m_maximum_size_flag) {                                                           \
            for (int i = 0; i < border_wd; ++i) {                                             \
                QVector<QLine> lines = {};                                                    \
                lines.push_back(QLine(i, i, w - i, i));                                       \
                lines.push_back(QLine(i, i, i, h - i));                                       \
                lines.push_back(QLine(i, h - i - 1, w - i, h - i - 1));                       \
                lines.push_back(QLine(w - i - 1, i, w - i - 1, h - i));                       \
                painter.setPen(color);                                                        \
                painter.drawLines(lines);                                                     \
            }                                                                                 \
        }                                                                                     \
    }
#else
    #error AW_FRAME_WIDGET declared repeatedly
#endif // !AW_FRAME_WIDGET

enum EAwTitleBarStyle {
    MENUABR_LOCATE_RIGHT_ICON,
    MENUABR_LOCATE_UNDER_ICON,
};

enum EAwTitleBarMsg {
    NONE,
    MIMIMUM_WINDOW,
    MAXIMUM_WINDOW,
    RESTORE_WINDOW,
    CLOSE_WINDOW,
};

class CAwTitleBar : public QWidget
{
    Q_OBJECT
public:
    explicit CAwTitleBar(QWidget *parent);
    void set_titlebar_style(EAwTitleBarStyle style);
    void insert_widget(qint32 index, QWidget *p_widget);
    void set_menubar(QMenuBar *p_menubar);
    QMenuBar *get_menubar();
    void set_window_title(QString title);
    void set_window_icon(QIcon icon);
    void set_icon_size(QSize size);
    void hide_min_maxrestore();
    QToolButton *get_close_btn();
    void set_maxrestore_btn_enabled(bool enabled);
    bool check_mouse_pt_on_proxy_widget(QWidget *p_widget);
signals:
    void change_window_state_request_sig(EAwTitleBarMsg);
private:
    QWidget *m_p_window;
    QWidget *m_p_proxy_widget;
    QBoxLayout *m_p_layout;
    QToolButton *m_p_icon;
    QToolButton *m_p_min;
    QToolButton *m_p_max_restore;
    QToolButton *m_p_close;
    QLabel *m_p_title_text;
    QMenuBar *m_p_menubar;
    EAwTitleBarStyle m_style;
    void instantiate_controls();
    void update_style();
    void set_horizontal_layout();
    void insert_widget_in_hlayout(qint32 index, QWidget *p_widget);
    void set_vertical_layout();
    void insert_widget_in_vlayout(qint32 index, QWidget *p_widget);
    void on_btn_clicked();
    void on_change_window_state(EAwTitleBarMsg msg);

protected:
    bool eventFilter(QObject *watched, QEvent *event);
};

#include "aw_titlebar.h"
#include <QHBoxLayout>
#include <QVBoxLayout>
#include <QToolButton>
#include <QLabel>
#include <QMenuBar>
#include <QEvent>

static const QMargins c_max_margin = QMargins(0, 0, 20, 0);
static const QMargins c_normal_margin = QMargins(0, 0, 0, 0);
static const QSize c_toolbtn_size = QSize(52, 31);
static const QSize c_icon_size = QSize(31, 31);
static const QString c_titlebar_min_objname = "titlebar_btn_min";
static const QString c_titlebar_maxrestore_objname = "titlebar_btn_maxrestore";
static const QString c_titlebar_close_objname = "titlebar_btn_close";
static const QString c_titlebar_icon_objname = "titlebar_btn_icon";
static const QString c_titlebar_titlebar_objname = "titlebar_widget";
static const QString c_titlebar_titlelbl_objname = "titlebar_title_label";
static const QString c_titlebar_menubar_objname = "titlebar_menu";
static const quint8 c_titlebar_icon_title_distance = 20;


CAwTitleBar::CAwTitleBar(QWidget *parent)
    : QWidget(parent),
      m_p_window(parent),
      m_p_proxy_widget(nullptr),
      m_p_layout(nullptr),
      m_p_icon(nullptr),
      m_p_min(nullptr),
      m_p_max_restore(nullptr),
      m_p_close(nullptr),
      m_p_title_text(nullptr),
      m_p_menubar(nullptr),
      m_style(EAwTitleBarStyle::MENUABR_LOCATE_RIGHT_ICON)
{
    instantiate_controls();
    set_icon_size(c_icon_size);
    update_style();
}

void CAwTitleBar::set_titlebar_style(EAwTitleBarStyle style)
{
    m_style = style;
    update_style();
}

void CAwTitleBar::insert_widget(qint32 index, QWidget *p_widget)
{
    switch (m_style) {
    case EAwTitleBarStyle::MENUABR_LOCATE_RIGHT_ICON:
        insert_widget_in_hlayout(index, p_widget);
        break;

    case EAwTitleBarStyle::MENUABR_LOCATE_UNDER_ICON:
        insert_widget_in_vlayout(index, p_widget);
        break;

    default:
        break;
    }
}

void CAwTitleBar::set_menubar(QMenuBar *p_menubar)
{
    QMap<EAwTitleBarStyle, qint8> menubar_index = {
        {EAwTitleBarStyle::MENUABR_LOCATE_RIGHT_ICON, 3},
        {EAwTitleBarStyle::MENUABR_LOCATE_UNDER_ICON, 1},
    };
    if ((p_menubar != nullptr) && (nullptr == m_p_menubar)) {
        m_p_menubar = p_menubar;
        m_p_menubar->setSizePolicy(QSizePolicy::Maximum, QSizePolicy::Maximum);
        m_p_menubar->setObjectName(c_titlebar_menubar_objname);
        insert_widget(menubar_index[m_style], p_menubar);
    }
}

QMenuBar *CAwTitleBar::get_menubar()
{
    if (nullptr == m_p_menubar) {
        set_menubar(new QMenuBar);
    }
    return m_p_menubar;
}

void CAwTitleBar::set_window_title(QString title)
{
    if (m_p_title_text != nullptr) {
        m_p_title_text->setText(title);
    }
}

void CAwTitleBar::set_window_icon(QIcon icon)
{
    if (m_p_icon != nullptr) {
        m_p_icon->setIcon(icon);
    }
}

void CAwTitleBar::set_icon_size(QSize size)
{
    if (m_p_icon != nullptr) {
        m_p_icon->setFixedSize(size);
        m_p_icon->setIconSize(size);
    }
}

void CAwTitleBar::hide_min_maxrestore()
{
    if (m_p_min != nullptr) {
        m_p_min->hide();
    }
    if (m_p_max_restore != nullptr) {
        m_p_max_restore->hide();
    }
}

QToolButton *CAwTitleBar::get_close_btn()
{
    return m_p_close;
}

void CAwTitleBar::set_maxrestore_btn_enabled(bool enabled)
{
    if (m_p_max_restore != nullptr) {
        m_p_max_restore->setEnabled(enabled);
    }
}

bool CAwTitleBar::check_mouse_pt_on_proxy_widget(QWidget *p_widget)
{
    return p_widget == m_p_proxy_widget;
}

void CAwTitleBar::instantiate_controls()
{
    QMap<QString, QToolButton **> title_bar_btn_list = {
        {c_titlebar_min_objname, &m_p_min},
        {c_titlebar_maxrestore_objname, &m_p_max_restore},
        {c_titlebar_close_objname, &m_p_close},
    };
    QHBoxLayout *p_layout = new QHBoxLayout(this);
    auto new_toolbar_btn = [this](QToolButton **p_btn, QString objname) -> void {
        if (p_btn != nullptr) {
            *p_btn = new QToolButton;
            (*p_btn)->setSizePolicy(QSizePolicy::Fixed, QSizePolicy::Expanding);
            (*p_btn)->setObjectName(objname);
            (*p_btn)->setFixedSize(c_toolbtn_size);
            connect(*p_btn, &QToolButton::clicked, this, &CAwTitleBar::on_btn_clicked);
        }
    };
    m_p_proxy_widget = new QWidget;
    p_layout->addWidget(m_p_proxy_widget);
    p_layout->setContentsMargins(c_normal_margin);
    m_p_proxy_widget->setObjectName(c_titlebar_titlebar_objname);
    m_p_icon = new QToolButton;
    m_p_icon->setSizePolicy(QSizePolicy::Fixed, QSizePolicy::Expanding);
    m_p_icon->setObjectName(c_titlebar_icon_objname);
    m_p_title_text = new QLabel;
    m_p_title_text->setObjectName(c_titlebar_titlelbl_objname);
    for (auto iter = title_bar_btn_list.begin(); iter != title_bar_btn_list.end(); iter++) {
        new_toolbar_btn(iter.value(), iter.key());
    }
    if (m_p_max_restore != nullptr) {
        m_p_max_restore->setCheckable(true);
        m_p_max_restore->setChecked(false);
    }
    if (m_p_window != nullptr) {
        m_p_window->installEventFilter(this);
    }
    connect(this, &CAwTitleBar::change_window_state_request_sig, this, &CAwTitleBar::on_change_window_state);
}

void CAwTitleBar::update_style()
{
    if (m_p_layout != nullptr) {
        delete m_p_layout;
        m_p_layout = nullptr;
    }
    switch (m_style) {
    case EAwTitleBarStyle::MENUABR_LOCATE_RIGHT_ICON:
        set_horizontal_layout();
        break;

    case EAwTitleBarStyle::MENUABR_LOCATE_UNDER_ICON:
        set_vertical_layout();
        break;

    default:
        break;
    }
}

void CAwTitleBar::set_horizontal_layout()
{
    QHBoxLayout *p_layout = new QHBoxLayout(m_p_proxy_widget);

    p_layout->addWidget(m_p_icon);
    p_layout->addWidget(m_p_title_text);
    p_layout->addSpacing(c_titlebar_icon_title_distance);
    p_layout->addStretch();
    p_layout->addWidget(m_p_min);
    p_layout->addWidget(m_p_max_restore);
    p_layout->addWidget(m_p_close);
    m_p_layout = p_layout;
    m_p_layout->setContentsMargins(c_normal_margin);
    m_p_layout->setSpacing(0);
}

void CAwTitleBar::insert_widget_in_hlayout(qint32 index, QWidget *p_widget)
{
    QHBoxLayout *p_layout = qobject_cast<QHBoxLayout *>(m_p_layout);

    if (p_layout != nullptr) {
        p_layout->insertWidget(index, p_widget);
    }
}

void CAwTitleBar::set_vertical_layout()
{
    QVBoxLayout *p_layout = new QVBoxLayout(m_p_proxy_widget);
    QHBoxLayout *p_layout_h = new QHBoxLayout;

    p_layout_h->addWidget(m_p_icon);
    p_layout_h->addWidget(m_p_title_text);
    p_layout_h->addStretch();
    p_layout_h->addWidget(m_p_min);
    p_layout_h->addWidget(m_p_max_restore);
    p_layout_h->addWidget(m_p_close);
    p_layout->addLayout(p_layout_h);
    m_p_layout = p_layout;
    m_p_layout->setContentsMargins(c_normal_margin);
    m_p_layout->setSpacing(0);
}

void CAwTitleBar::insert_widget_in_vlayout(qint32 index, QWidget *p_widget)
{
    QVBoxLayout *p_layout = qobject_cast<QVBoxLayout *>(m_p_layout);

    if (p_layout != nullptr) {
        p_layout->insertWidget(index, p_widget);
    }
}

void CAwTitleBar::on_btn_clicked()
{
    QToolButton *p_btn = qobject_cast<QToolButton *>(sender());
    EAwTitleBarMsg ret = EAwTitleBarMsg::NONE;

    if ((p_btn != nullptr) && (m_p_window != nullptr)) {
        if (p_btn == m_p_min) {
            ret = EAwTitleBarMsg::MIMIMUM_WINDOW;
        } else if (p_btn == m_p_close) {
            ret = EAwTitleBarMsg::CLOSE_WINDOW;
        } else if (p_btn == m_p_max_restore) {
            ret = p_btn->isChecked() ? EAwTitleBarMsg::MAXIMUM_WINDOW : EAwTitleBarMsg::RESTORE_WINDOW;
        }
        if (ret != EAwTitleBarMsg::NONE) {
            emit change_window_state_request_sig(ret);
        }
    }
}

void CAwTitleBar::on_change_window_state(EAwTitleBarMsg msg)
{
    if ((m_p_window != nullptr) && m_p_window->isWindow()) {
        switch (msg) {
        case EAwTitleBarMsg::MIMIMUM_WINDOW:
            m_p_window->showMinimized();
            break;

        case EAwTitleBarMsg::MAXIMUM_WINDOW:
            m_p_window->showMaximized();
            break;

        case EAwTitleBarMsg::RESTORE_WINDOW:
            m_p_window->showNormal();
            break;

        case EAwTitleBarMsg::CLOSE_WINDOW:
            m_p_window->close();
            break;

        default:
            break;
        }
    }
}

bool CAwTitleBar::eventFilter(QObject *watched, QEvent *event)
{
    bool flag = false;
    QVariant var;

    if ((watched == m_p_window) && (m_p_window != nullptr) && (m_p_max_restore != nullptr)) {
        var = m_p_window->property(AWFRAME_MAXSIZE_PROPERTY);
        flag = var.isValid() ? var.toBool() : m_p_window->isMaximized();
        if (event->type() == QEvent::Resize) {
            m_p_max_restore->blockSignals(true);
            m_p_max_restore->setChecked(flag);
            setFixedWidth(m_p_window->width() - 2);
            m_p_max_restore->blockSignals(false);
        }
        if (m_p_layout != nullptr) {
            m_p_layout->setContentsMargins(flag ? c_max_margin : c_normal_margin);
        }
    }
    return QWidget::eventFilter(watched, event);
}

```



***mainwindow***

```c++
#pragma once

#include <qmainwindow.h>
#include "aw_titlebar.h"

class CAwMainWindow : public QMainWindow
{
    Q_OBJECT
    AW_FRAME_WIDGET
public:
    explicit CAwMainWindow(QWidget *parent = nullptr);
    void setMenuBar(QMenuBar *p_menuBar);
    QMenuBar *menuBar();
    CAwTitleBar *get_titlebar();
private:
    void init_mainwindow();
protected:
    void setMenuWidget(QWidget *p_menuBar);
};


#include "aw_mainwindow.h"
#include <QStatusBar>
#include <QApplication>

static const QSize c_mainwindow_default_size = QSize(640, 480);

CAwMainWindow::CAwMainWindow(QWidget *parent)
    : QMainWindow(parent)
{
    init_mainwindow();
    set_hwnd_options();
}

void CAwMainWindow::setMenuBar(QMenuBar *p_menuBar)
{
    if (m_p_title_bar != nullptr) {
        m_p_title_bar->set_menubar(p_menuBar);
    }
}

QMenuBar *CAwMainWindow::menuBar()
{
    QMenuBar *p_menubar = nullptr;

    if (m_p_title_bar != nullptr) {
        p_menubar = m_p_title_bar->get_menubar();
    }
    return p_menubar;
}

CAwTitleBar *CAwMainWindow::get_titlebar()
{
    return m_p_title_bar;
}

void CAwMainWindow::init_mainwindow()
{
    resize(c_mainwindow_default_size);
    setMenuWidget(m_p_title_bar);
}

void CAwMainWindow::setMenuWidget(QWidget *p_menuBar)
{
    if (p_menuBar != nullptr) {
        m_p_title_bar = qobject_cast<CAwTitleBar *>(p_menuBar);
        QMainWindow::setMenuWidget(m_p_title_bar);
    }
}
```







***messagebox***

```c++
#pragma once
#include "aw_dialog.h"
#include <QMessageBox>

class QFrame;
class QLabel;
class QToolButton;
class QDialogButtonBox;
class QAbstractButton;

class CAwMessageBox : public CAwDialog
{
    Q_OBJECT
public:
    explicit CAwMessageBox(QWidget *parent = nullptr);

    static void  about(QWidget *parent, const QString &title, const QString &text);

    static void aboutQt(QWidget *parent, const QString &title = QString());

    static QMessageBox::StandardButton critical(
            QWidget *parent,
            const QString &title,
            const QString &text,
            QMessageBox::StandardButtons buttons = QMessageBox::Ok,
            QMessageBox::StandardButton defaultButton = QMessageBox::NoButton);

    static QMessageBox::StandardButton information(
            QWidget *parent,
            const QString &title, const QString &text,
            QMessageBox::StandardButtons buttons = QMessageBox::Ok,
            QMessageBox::StandardButton defaultButton = QMessageBox::NoButton);

    static QMessageBox::StandardButton question(
            QWidget *parent,
            const QString &title,
            const QString &text,
            QMessageBox::StandardButtons buttons = QMessageBox::StandardButtons(QMessageBox::Yes | QMessageBox::No),
            QMessageBox::StandardButton defaultButton = QMessageBox::NoButton);

    static QMessageBox::StandardButton warning(
            QWidget *parent,
            const QString &title,
            const QString &text,
            QMessageBox::StandardButtons buttons = QMessageBox::Ok,
            QMessageBox::StandardButton defaultButton = QMessageBox::NoButton);

private:
    QFrame *m_p_frame;
    QLabel *m_p_icon;
    QLabel *m_p_msg;
    QDialogButtonBox *m_p_btnbox;
    QMessageBox::StandardButton m_clicked_btn;

    void create_layout();
    void bind_event();
    void set_icon(QMessageBox::Icon icon);
    void set_msg(QString text);
    void set_standard_buttons(QMessageBox::StandardButtons buttons);
    void set_default_button(QMessageBox::StandardButton default_button);
    void on_button_clicked(QAbstractButton *p_btn);
    void disable_titlebar_close_btn();
    bool eventFilter(QObject *watched, QEvent *event);
    void set_messagebox_information(
        QMessageBox::Icon icon,
        const QString &title,
        const QString &text,
        QMessageBox::StandardButtons buttons,
        QMessageBox::StandardButton default_button);
};


#include "aw_messagebox.h"
#include <QFrame>
#include <QLabel>
#include <QDialogButtonBox>
#include <QHBoxLayout>
#include <QVBoxLayout>
#include <QStyle>
#include <QApplication>
#include <QToolButton>
#include <QAbstractButton>
#include <QFontMetrics>

static const qint32 c_msgbox_max_width = 400;
static const qint32 c_msgbox_contents_margin = 50;
static const qint32 c_msgbox_icon_text_space = 5;
static const QSize c_msgbox_icon_size = QSize(40, 40);
static const QSize c_msgbox_titlebar_closebtn_size = QSize(34, 25);
static const QMargins c_msgbox_frame_margin = QMargins(0, 0, 0, 0);
static const QMargins c_msgbox_margin = QMargins(9, 9, 9, 9);

CAwMessageBox::CAwMessageBox(QWidget *parent)
    : CAwDialog(parent),
      m_p_frame(nullptr),
      m_p_icon(nullptr),
      m_p_msg(nullptr),
      m_p_btnbox(nullptr),
      m_clicked_btn(QMessageBox::Cancel)
{
    create_layout();
    bind_event();
}

void CAwMessageBox::set_icon(QMessageBox::Icon icon)
{
    QStyle *p_style = QApplication::style();
    QMap<QMessageBox::Icon, QStyle::StandardPixmap> srcs = {
        {QMessageBox::Information, QStyle::SP_MessageBoxInformation},
        {QMessageBox::Warning, QStyle::SP_MessageBoxWarning},
        {QMessageBox::Critical, QStyle::SP_MessageBoxCritical},
        {QMessageBox::Question, QStyle::SP_MessageBoxQuestion},
    };

    if ((p_style != nullptr) && (m_p_icon != nullptr) && srcs.contains(icon)) {
        QIcon icon_src = p_style->standardIcon(srcs[icon]);
        m_p_icon->setPixmap(icon_src.pixmap(c_msgbox_icon_size));
        m_p_icon->setVisible(!icon_src.isNull());
    }
}

void CAwMessageBox::about(QWidget *parent, const QString &title, const QString &text)
{
    CAwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::NoIcon, title, text, QMessageBox::Ok, QMessageBox::Ok);
    w.exec();
}

void CAwMessageBox::aboutQt(QWidget *parent, const QString &title)
{
    QMessageBox::aboutQt(parent, title);
}

QMessageBox::StandardButton CAwMessageBox::critical(QWidget *parent, const QString &title, const QString &text,
    QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    CAwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::Critical, title, text, buttons, default_button);
    w.exec();
    return w.m_clicked_btn;
}

QMessageBox::StandardButton CAwMessageBox::information(QWidget *parent, const QString &title, const QString &text,
    QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    CAwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::Information, title, text, buttons, default_button);
    w.exec();
    return w.m_clicked_btn;
}

QMessageBox::StandardButton CAwMessageBox::question(QWidget *parent, const QString &title, const QString &text,
    QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    CAwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::Question, title, text, buttons, default_button);
    w.exec();
    return w.m_clicked_btn;
}

QMessageBox::StandardButton CAwMessageBox::warning(QWidget *parent, const QString &title, const QString &text,
    QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    CAwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::Warning, title, text, buttons, default_button);
    w.exec();
    return w.m_clicked_btn;
}

void CAwMessageBox::create_layout()
{
    QHBoxLayout *p_mainlayout = new QHBoxLayout;
    QVBoxLayout *p_framelayout = new QVBoxLayout;
    QHBoxLayout *p_icon_msg = new QHBoxLayout;

    m_p_frame = new QFrame;
    m_p_icon = new QLabel;
    m_p_msg = new QLabel;
    m_p_btnbox = new QDialogButtonBox;

    m_p_icon->hide();
    m_p_icon->setFixedSize(c_msgbox_icon_size);
    m_p_msg->setWordWrap(true);
    m_p_msg->setSizePolicy(QSizePolicy::Fixed, QSizePolicy::Fixed);

    p_icon_msg->addWidget(m_p_icon);
    p_icon_msg->addWidget(m_p_msg);
    p_icon_msg->setSpacing(c_msgbox_icon_text_space);

    p_framelayout->addLayout(p_icon_msg);
    p_framelayout->addWidget(m_p_btnbox);
    p_framelayout->setContentsMargins(c_msgbox_frame_margin);
    m_p_frame->setLayout(p_framelayout);

    p_mainlayout->addWidget(m_p_frame);
    p_mainlayout->setContentsMargins(c_msgbox_margin);

    setLayout(p_mainlayout);
    disable_titlebar_close_btn();
    setSizePolicy(QSizePolicy::Fixed, QSizePolicy::Fixed);
}

void CAwMessageBox::bind_event()
{
    connect(m_p_btnbox, &QDialogButtonBox::clicked, this, &CAwMessageBox::on_button_clicked);
}

void CAwMessageBox::set_msg(QString text)
{
    if (m_p_msg != nullptr) {
        m_p_msg->setText(text);
        m_p_msg->setMinimumWidth(qMin(c_msgbox_max_width, \
            QFontMetrics(m_p_msg->font()).horizontalAdvance(text) + c_msgbox_contents_margin));
    }
}

void CAwMessageBox::set_standard_buttons(QMessageBox::StandardButtons buttons)
{
    if (m_p_btnbox != nullptr) {
        m_p_btnbox->setStandardButtons(QDialogButtonBox::StandardButtons(static_cast<int>(buttons)));
    }
}

void CAwMessageBox::set_default_button(QMessageBox::StandardButton default_button)
{
    QPushButton *p_default_button = nullptr;

    if (m_p_btnbox != nullptr) {
        p_default_button = m_p_btnbox->button(QDialogButtonBox::StandardButton(default_button));
    }
    if (p_default_button != nullptr) {
        p_default_button->setDefault(true);
    }
}

void CAwMessageBox::set_messagebox_information(
        QMessageBox::Icon icon, const QString &title, const QString &text,
        QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    installEventFilter(this);
    setWindowTitle(title);
    set_standard_buttons(buttons);
    set_default_button(default_button);
    set_icon(icon);
    set_msg(text);
}

void CAwMessageBox::on_button_clicked(QAbstractButton *p_btn)
{
    if (m_p_btnbox != nullptr) {
        m_clicked_btn = QMessageBox::StandardButton(m_p_btnbox->standardButton(p_btn));
        done(m_clicked_btn);
    }
}

void CAwMessageBox::disable_titlebar_close_btn()
{
    CAwTitleBar *p_titlebar = get_titlebar();
    QToolButton *p_titlebar_close = nullptr;

    if (p_titlebar != nullptr) {
        p_titlebar_close = p_titlebar->get_close_btn();
        if (p_titlebar_close != nullptr) {
            p_titlebar_close->setEnabled(false);
            p_titlebar_close->setFixedSize(c_msgbox_titlebar_closebtn_size);
        }
    }
}

bool CAwMessageBox::eventFilter(QObject *watched, QEvent *event)
{
    if (event->type() == QEvent::Resize) {
        return true;
    }
    return CAwDialog::eventFilter(watched, event);
}

```





***dialog***

```c++
#pragma once
#include "aw_titlebar.h"
#include <QDialog>

class QVBoxLayout;

class CAwDialog : public QDialog
{
    Q_OBJECT
    AW_FRAME_WIDGET
public:
    explicit CAwDialog(QWidget *parent = nullptr);
    void setLayout(QLayout *layout);
    CAwTitleBar *get_titlebar();
private:
    QVBoxLayout *m_p_layout;
    QWidget *m_p_center_widget;
    void init_dialog();
    void init_layout();
};

#include "aw_dialog.h"
#include <QVBoxLayout>

static const QSize c_dialog_default_size = QSize(640, 480);

CAwDialog::CAwDialog(QWidget *parent)
    : QDialog(parent),
      m_p_layout(nullptr),
      m_p_center_widget(nullptr)
{
    init_dialog();
    set_hwnd_options();
}

void CAwDialog::setLayout(QLayout *layout)
{
    if (m_p_center_widget != nullptr) {
        m_p_center_widget->setLayout(layout);
    }
}

CAwTitleBar *CAwDialog::get_titlebar()
{
    return m_p_title_bar;
}

void CAwDialog::init_dialog()
{
    init_layout();
}

void CAwDialog::init_layout()
{
    m_p_layout = new QVBoxLayout(this);
    m_p_center_widget = new QWidget;
    m_p_layout->setContentsMargins(0, 0, 0, 0);
    m_p_layout->setSpacing(0);
    m_p_layout->addWidget(m_p_title_bar);
    m_p_layout->addWidget(m_p_center_widget);
    if (m_p_title_bar != nullptr) {
        m_p_title_bar->hide_min_maxrestore();
        m_p_title_bar->setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Maximum);
    }
    resize(c_dialog_default_size);
}

```

