```c++
#pragma once
#include "ww_titlebar_abstract.h"
#include <Windows.h>
#include <QtWin>
#include <dwmapi.h>
#include <QPushButton>
#include <QPainter>
#include <QVariant>
#include <QEvent>
#include <QApplication>
#include <QSettings>

class CWwMainWindow;
class QBoxLayout;
class QLabel;
class CWwTitleBar;

#ifndef WwFRAME_WIDGET_MAXSIZE_PROPERTY
    #define WwFRAME_MAXSIZE_PROPERTY ("IS_MAX_SIZE")
#else
    #error WwFRAME_WIDGET_MAXSIZE_PROPERTY declared repeatedly
#endif // !WwFRAME_WIDGET_MAXSIZE_PROPERTY

#ifndef WwFRAME_WIDGET_BORDER_WIDTH
#define WwFRAME_WIDGET_BORDER_WIDTH (5)
#else
#error WwFRAME_WIDGET_BORDER_WIDTH declared repeatedly
#endif // !WwFRAME_WIDGET_BORDER_WIDTH

#ifndef WwFRAME_WIDGET_BORDER_LINE_WIDTH
#define WwFRAME_WIDGET_BORDER_LINE_WIDTH (1)
#else
#error WwFRAME_WIDGET_BORDER__LINE_WIDTH declared repeatedly
#endif // !WwFRAME_WIDGET_BORDER__LINE_WIDTH

#ifndef WwFRAME_WIDGET_BORDER_COLOR
#define WwFRAME_WIDGET_BORDER_COLOR (QColor("#87c6c5"))
#else
#error WwFRAME_WIDGET_BORDER_COLOR declared repeatedly
#endif // !WwFRAME_WIDGET_BORDER_COLOR

#ifndef WwFRAME_WIDGET_CONTENTS_MARGIN
    #define WwFRAME_WIDGET_CONTENTS_MARGIN (QMargins(1, 1, 1, 1))
#else
    #error WwFRAME_WIDGET_CONTENTS_MARGIN declared repeatedly
#endif // !WwFRAME_WIDGET_CONTENTS_MARGIN

#ifndef ww_FRAME_WIDGET
    #define ww_FRAME_WIDGET                                                                   \
public:                                                                                       \
    void set_icon_dragable(bool dragable)                                                     \
    {                                                                                         \
        if (m_p_title_bar != nullptr) {                                                       \
            m_p_title_bar->set_icon_dragable(dragable);                                       \
        }                                                                                     \
    }                                                                                         \
    static void set_border_color(QColor color)                                                \
    {                                                                                         \
        border_color = color;                                                                 \
    }                                                                                         \
    void setWindowTitle(const QString &window_title) {                                        \
        if (m_p_title_bar != nullptr) {                                                       \
            m_p_title_bar->set_window_title(window_title);                                    \
        }                                                                                     \
        QWidget::setWindowTitle(window_title);                                                \
    }                                                                                         \
    void setWindowIcon(const QIcon &icon)                                                     \
    {                                                                                         \
        if (m_p_title_bar != nullptr) {                                                       \
            m_p_title_bar->set_window_icon(icon);                                             \
        }                                                                                     \
        QWidget::setWindowIcon(icon);                                                         \
    }                                                                                         \
    void setIconSize(const QSize &size)                                                       \
    {                                                                                         \
        if (m_p_title_bar != nullptr) {                                                       \
            m_p_title_bar->set_icon_size(size);                                               \
        }                                                                                     \
    }                                                                                         \
    bool isMaximized() const                                                                  \
    {                                                                                         \
        return m_maximum_size_flag;                                                           \
    }                                                                                         \
    void setFixedWidth(qint32 width)                                                          \
    {                                                                                         \
        if (m_fixed_height_flag) {                                                            \
            setFixedSize(width, height());                                                    \
        } else {                                                                              \
            QWidget::setFixedWidth(width);                                                    \
            m_fixed_width_flag = true;                                                        \
        }                                                                                     \
    }                                                                                         \
    void setFixedHeight(qint32 height)                                                        \
    {                                                                                         \
        if (m_fixed_width_flag) {                                                             \
            setFixedSize(width(), height);                                                    \
        } else {                                                                              \
            QWidget::setFixedHeight(height);                                                  \
            m_fixed_height_flag = true;                                                       \
        }                                                                                     \
    }                                                                                         \
    void setFixedSize(QSize size)                                                             \
    {                                                                                         \
        setFixedSize(size.width(), size.height());                                            \
    }                                                                                         \
    void setFixedSize(qint32 w, qint32 h)                                                     \
    {                                                                                         \
        resize(w, h);                                                                         \
        remove_window_thickframe();                                                           \
        m_fixed_width_flag = true;                                                            \
        m_fixed_height_flag = true;                                                           \
    }                                                                                         \
private:                                                                                      \
    CWwTitleBar *m_p_title_bar{new CWwTitleBar(this)};                                        \
    static QColor border_color;                                                               \
    bool m_maximum_size_flag{false};                                                          \
    bool m_fixed_width_flag{false};                                                           \
    bool m_fixed_height_flag{false};                                                          \
    void set_hwnd_options()                                                                   \
    {                                                                                         \
        setWindowFlag(Qt::FramelessWindowHint);                                               \
        setWindowIcon(QtWin::fromHICON(LoadIcon(NULL, IDI_APPLICATION)));                     \
        setContentsMargins(WwFRAME_WIDGET_CONTENTS_MARGIN);                                   \
        if (QtWin::isCompositionEnabled()) {                                                  \
            HWND hwnd = (HWND)this->winId();                                                  \
            DWORD style = ::GetWindowLong(hwnd, GWL_STYLE);                                   \
            ::SetWindowLong(hwnd, GWL_STYLE, style | WS_THICKFRAME | WS_CAPTION | WS_BORDER); \
            QtWin::extendFrameIntoClientArea(this, 1, 1, 1, 1);                               \
        }                                                                                     \
    }                                                                                         \
    LRESULT calculate_border(const QPoint &pt)                                                \
    {                                                                                         \
        int border_size = WwFRAME_WIDGET_BORDER_WIDTH;                                        \
        int cx = this->size().width();                                                        \
        int cy = this->size().height();                                                       \
        LRESULT ret = HTCLIENT;                                                               \
        QRect rect_top_left(0, 0, border_size, border_size);                                  \
        QRect rect_left(0, border_size, border_size, cy - border_size * 2);                   \
        QRect rect_top_right(cx - border_size, 0, border_size, border_size);                  \
        QRect rect_right(cx - border_size, border_size, border_size, cy - border_size * 2);   \
        QRect rect_top(border_size, 0, cx - border_size * 2, border_size);                    \
        QRect rect_bottom_left(0, cy - border_size, border_size, border_size);                \
        QRect rect_bottom_right(cx - border_size, cy - border_size, border_size, border_size); \
        QRect rect_bottom(border_size, cy - border_size, cx - border_size * 2, border_size);  \
                                                                                              \
        if (::IsZoomed((HWND)this->winId())) {                                                \
            ret = HTCLIENT;                                                                   \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_top_left.contains(pt)) {                                                     \
            ret = HTTOPLEFT;                                                                  \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_left.contains(pt)) {                                                         \
            ret = HTLEFT;                                                                     \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_top_right.contains(pt)) {                                                    \
            ret = HTTOPRIGHT;                                                                 \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_right.contains(pt)) {                                                        \
            ret = HTRIGHT;                                                                    \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_top.contains(pt)) {                                                          \
            ret = HTTOP;                                                                      \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_bottom_left.contains(pt)) {                                                  \
            ret = HTBOTTOMLEFT;                                                               \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_bottom_right.contains(pt)) {                                                 \
            ret = HTBOTTOMRIGHT;                                                              \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        if (rect_bottom.contains(pt)) {                                                       \
            ret = HTBOTTOM;                                                                   \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
    EXIT:                                                                                     \
        return ret;                                                                           \
    }                                                                                         \
    void remove_window_thickframe()                                                           \
    {                                                                                         \
        HWND hwnd = (HWND)this->winId();                                                      \
        DWORD style = GetWindowLong(hwnd, GWL_STYLE);                                         \
        style &= ~WS_THICKFRAME;                                                              \
        SetWindowLong(hwnd, GWL_STYLE, style);                                                \
        if (m_p_title_bar != nullptr) {                                                       \
            m_p_title_bar->set_maxrestore_btn_enabled(false);                                 \
        }                                                                                     \
    }                                                                                         \
                                                                                              \
protected:                                                                                    \
    bool nativeEvent(const QByteArray &event_type, void *p_message, long *p_result)           \
    {                                                                                         \
        bool ret = false;                                                                     \
                                                                                              \
        MSG *p_msg = static_cast<MSG *>(p_message);                                           \
        QWidget *p_widget = QWidget::find(reinterpret_cast<WId>(p_msg->hwnd));                \
        if (event_type != "windows_generic_MSG") {                                            \
            goto EXIT;                                                                        \
        }                                                                                     \
        if (nullptr == p_widget) {                                                            \
            goto EXIT;                                                                        \
        }                                                                                     \
                                                                                              \
        switch (p_msg->message) {                                                             \
        case WM_NCCALCSIZE: {                                                                 \
            *p_result = 0;                                                                    \
            ret = true;                                                                       \
            goto EXIT;                                                                        \
        }                                                                                     \
            break;                                                                            \
                                                                                              \
        case WM_NCHITTEST: {                                                                  \
            qint32 x = (static_cast<qint32>(static_cast<short>(LOWORD(p_msg->lParam))));      \
            qint32 y = (static_cast<qint32>(static_cast<short>(HIWORD(p_msg->lParam))));      \
            QPoint pt = mapFromGlobal(QPoint(x, y));                                          \
            *p_result = calculate_border(pt);                                                 \
            if (*p_result == HTCLIENT) {                                                      \
                if (m_p_title_bar != nullptr && m_p_title_bar->rect().contains(pt)) {         \
                    QWidget *p_child = m_p_title_bar->childAt(pt);                            \
                    if (m_p_title_bar->check_mouse_pt_on_proxy_widget(p_child)) {             \
                        *p_result = HTCAPTION;                                                \
                    }                                                                         \
                }                                                                             \
            }                                                                                 \
            ret = true;                                                                       \
            goto EXIT;                                                                        \
        }                                                                                     \
            break;                                                                            \
                                                                                              \
        case WM_GETMINMAXINFO: {                                                              \
            if (::IsZoomed(p_msg->hwnd)) {                                                    \
                RECT frame = { 0, 0, 0, 0 };                                                  \
                m_maximum_size_flag = true;                                                   \
                AdjustWindowRectEx(&frame, WS_OVERLAPPEDWINDOW, FALSE, 0);                    \
                frame.left = abs(frame.left);                                                 \
                frame.top = abs(frame.bottom);                                                \
                p_widget->setContentsMargins(frame.left - 1, frame.top - 1,                   \
                                             frame.right, frame.bottom);                      \
            } else {                                                                          \
                p_widget->setContentsMargins(WwFRAME_WIDGET_CONTENTS_MARGIN);                 \
                m_maximum_size_flag = false;                                                  \
            }                                                                                 \
            *p_result = ::DefWindowProc(p_msg->hwnd, p_msg->message, p_msg->wParam, p_msg->lParam); \
            p_widget->setProperty(WwFRAME_MAXSIZE_PROPERTY, QVariant(m_maximum_size_flag));   \
            ret = true;                                                                       \
            goto EXIT;                                                                        \
        }                                                                                     \
            break;                                                                            \
                                                                                              \
        case WM_NCLBUTTONDBLCLK: {                                                            \
            HWND hwnd = (HWND)this->winId();                                                  \
            DWORD style = GetWindowLong(hwnd, GWL_STYLE);                                     \
            ret = !(style & WS_THICKFRAME);                                                   \
            goto EXIT;                                                                        \
        }                                                                                     \
        break;                                                                                \
                                                                                              \
        default:                                                                              \
            break;                                                                            \
        }                                                                                     \
    EXIT:                                                                                     \
        return ret;                                                                           \
    }                                                                                         \
    void paintEvent(QPaintEvent *p_event)                                                     \
    {                                                                                         \
        Q_UNUSED(p_event)                                                                     \
        int border_wd = WwFRAME_WIDGET_BORDER_LINE_WIDTH;                                     \
        int w = width();                                                                      \
        int h = height();                                                                     \
        QPainter painter(this);                                                               \
                                                                                              \
        if (!m_maximum_size_flag) {                                                           \
            for (int i = 0; i < border_wd; ++i) {                                             \
                QVector<QLine> lines = {};                                                    \
                lines.push_back(QLine(i, i, w - i, i));                                       \
                lines.push_back(QLine(i, i, i, h - i));                                       \
                lines.push_back(QLine(i, h - i - 1, w - i, h - i - 1));                       \
                lines.push_back(QLine(w - i - 1, i, w - i - 1, h - i));                       \
                painter.setPen(border_color);                                                 \
                painter.drWwLines(lines);                                                     \
            }                                                                                 \
        }                                                                                     \
    }
#else
    #error ww_FRAME_WIDGET declared repeatedly
#endif // !ww_FRAME_WIDGET

class CWwTitleBar : public CWwAbstractTitleBar
{
    Q_OBJECT

public:
    explicit CWwTitleBar(QWidget *p_parent);

    void set_titlebar_style(EWwTitleBarStyle style) override;
    void insert_widget(qint32 index, QWidget *p_widget) override;
    void set_menubar(QMenuBar *p_menubar) override;
    QMenuBar *get_menubar() override;
    void set_window_title(QString title) override;
    void set_window_icon(QIcon icon) override;
    void set_icon_size(QSize size) override;
    void hide_min_maxrestore() override;
    QToolButton *get_close_btn() override;
    void set_maxrestore_btn_enabled(bool enabled) override;
    bool check_mouse_pt_on_proxy_widget(QWidget *p_widget) override;
    void set_icon_dragable(bool dragable) override;

private:
    QWidget *m_p_window;
    QWidget *m_p_proxy_widget;
    QBoxLayout *m_p_layout;
    QToolButton *m_p_icon;
    QToolButton *m_p_min;
    QToolButton *m_p_max_restore;
    QToolButton *m_p_close;
    QLabel *m_p_title_text;
    QMenuBar *m_p_menubar;
    EWwTitleBarStyle m_style;
    bool m_icon_dragable;
    void instantiate_controls();
    void update_style();
    void set_horizontal_layout();
    void insert_widget_in_hlayout(qint32 index, QWidget *p_widget);
    void set_vertical_layout();
    void insert_widget_in_vlayout(qint32 index, QWidget *p_widget);
    void on_btn_clicked();
    void on_change_window_state(EWwTitleBarMsg msg);

protected:
    bool eventFilter(QObject *watched, QEvent *event) override;
};


#include "ww_titlebar.h"
#include <QHBoxLayout>
#include <QVBoxLayout>
#include <QToolButton>
#include <QLabel>
#include <QMenuBar>
#include <QEvent>

static const QMargins c_max_margin = QMargins(0, 0, 20, 0);
static const QMargins c_normal_margin = QMargins(0, 0, 0, 0);
static const QSize c_toolbtn_size = QSize(52, 31);
static const QSize c_icon_size = QSize(31, 31);
static const QString c_titlebar_min_objname = "titlebar_btn_min";
static const QString c_titlebar_maxrestore_objname = "titlebar_btn_maxrestore";
static const QString c_titlebar_close_objname = "titlebar_btn_close";
static const QString c_titlebar_icon_objname = "titlebar_btn_icon";
static const QString c_titlebar_titlebar_objname = "titlebar_widget";
static const QString c_titlebar_titlelbl_objname = "titlebar_title_label";
static const QString c_titlebar_menubar_objname = "titlebar_menu";
static const quint8 c_titlebar_icon_title_distance = 20;


CWwTitleBar::CWwTitleBar(QWidget *p_parent)
    : m_p_window(p_parent),
      m_p_proxy_widget(nullptr),
      m_p_layout(nullptr),
      m_p_icon(nullptr),
      m_p_min(nullptr),
      m_p_max_restore(nullptr),
      m_p_close(nullptr),
      m_p_title_text(nullptr),
      m_p_menubar(nullptr),
      m_style(EWwTitleBarStyle::MENUABR_LOCATE_RIGHT_ICON),
      m_icon_dragable(true)
{
    instantiate_controls();
    set_icon_size(c_icon_size);
    update_style();
}

void CWwTitleBar::set_titlebar_style(EWwTitleBarStyle style)
{
    m_style = style;
    update_style();
}

void CWwTitleBar::insert_widget(qint32 index, QWidget *p_widget)
{
    switch (m_style) {
    case EWwTitleBarStyle::MENUABR_LOCATE_RIGHT_ICON:
        insert_widget_in_hlayout(index, p_widget);
        break;

    case EWwTitleBarStyle::MENUABR_LOCATE_UNDER_ICON:
        insert_widget_in_vlayout(index, p_widget);
        break;

    default:
        break;
    }
}

void CWwTitleBar::set_menubar(QMenuBar *p_menubar)
{
    QMap<EWwTitleBarStyle, qint8> menubar_index = {
        {EWwTitleBarStyle::MENUABR_LOCATE_RIGHT_ICON, 3},
        {EWwTitleBarStyle::MENUABR_LOCATE_UNDER_ICON, 1},
    };
    if ((p_menubar != nullptr) && (nullptr == m_p_menubar)) {
        m_p_menubar = p_menubar;
        m_p_menubar->setSizePolicy(QSizePolicy::Maximum, QSizePolicy::Maximum);
        m_p_menubar->setObjectName(c_titlebar_menubar_objname);
        insert_widget(menubar_index[m_style], p_menubar);
    }
}

QMenuBar *CWwTitleBar::get_menubar()
{
    if (nullptr == m_p_menubar) {
        set_menubar(new QMenuBar);
    }
    return m_p_menubar;
}

void CWwTitleBar::set_window_title(QString title)
{
    if (m_p_title_text != nullptr) {
        m_p_title_text->setText(title);
    }
}

void CWwTitleBar::set_window_icon(QIcon icon)
{
    if (m_p_icon != nullptr) {
        m_p_icon->setIcon(icon);
    }
}

void CWwTitleBar::set_icon_size(QSize size)
{
    if (m_p_icon != nullptr) {
        m_p_icon->setFixedSize(size);
        m_p_icon->setIconSize(size);
    }
}

void CWwTitleBar::hide_min_maxrestore()
{
    if (m_p_min != nullptr) {
        m_p_min->hide();
    }
    if (m_p_max_restore != nullptr) {
        m_p_max_restore->hide();
    }
}

QToolButton *CWwTitleBar::get_close_btn()
{
    return m_p_close;
}

void CWwTitleBar::set_maxrestore_btn_enabled(bool enabled)
{
    if (m_p_max_restore != nullptr) {
        m_p_max_restore->setEnabled(enabled);
    }
}

bool CWwTitleBar::check_mouse_pt_on_proxy_widget(QWidget *p_widget)
{
    return (p_widget == m_p_proxy_widget) ||
           (p_widget == m_p_title_text) ||
           (m_icon_dragable && (p_widget == m_p_icon));
}

void CWwTitleBar::set_icon_dragable(bool dragable)
{
    m_icon_dragable = dragable;
}

void CWwTitleBar::instantiate_controls()
{
    QMap<QString, QToolButton **> title_bar_btn_list = {
        {c_titlebar_min_objname, &m_p_min},
        {c_titlebar_maxrestore_objname, &m_p_max_restore},
        {c_titlebar_close_objname, &m_p_close},
    };
    QHBoxLayout *p_layout = new QHBoxLayout(this);
    auto new_toolbar_btn = [this](QToolButton **p_btn, QString objname) -> void {
        if (p_btn != nullptr) {
            *p_btn = new QToolButton;
            (*p_btn)->setSizePolicy(QSizePolicy::Fixed, QSizePolicy::Expanding);
            (*p_btn)->setObjectName(objname);
            (*p_btn)->setFixedSize(c_toolbtn_size);
            connect(*p_btn, &QToolButton::clicked, this, &CWwTitleBar::on_btn_clicked);
        }
    };
    m_p_proxy_widget = new QWidget;
    p_layout->addWidget(m_p_proxy_widget);
    p_layout->setContentsMargins(c_normal_margin);
    m_p_proxy_widget->setObjectName(c_titlebar_titlebar_objname);
    m_p_icon = new QToolButton;
    m_p_icon->setSizePolicy(QSizePolicy::Fixed, QSizePolicy::Expanding);
    m_p_icon->setObjectName(c_titlebar_icon_objname);
    m_p_title_text = new QLabel;
    m_p_title_text->setObjectName(c_titlebar_titlelbl_objname);
    for (auto iter = title_bar_btn_list.begin(); iter != title_bar_btn_list.end(); iter++) {
        new_toolbar_btn(iter.value(), iter.key());
    }
    if (m_p_max_restore != nullptr) {
        m_p_max_restore->setCheckable(true);
        m_p_max_restore->setChecked(false);
    }
    if (m_p_window != nullptr) {
        m_p_window->installEventFilter(this);
        if (m_p_window->inherits("QMainWindow")) {
            p_layout->addSpacing(2);
        }
    }
    connect(this, &CWwTitleBar::change_window_state_request_sig, this, &CWwTitleBar::on_change_window_state);
}

void CWwTitleBar::update_style()
{
    if (m_p_layout != nullptr) {
        delete m_p_layout;
        m_p_layout = nullptr;
    }
    switch (m_style) {
    case EWwTitleBarStyle::MENUABR_LOCATE_RIGHT_ICON:
        set_horizontal_layout();
        break;

    case EWwTitleBarStyle::MENUABR_LOCATE_UNDER_ICON:
        set_vertical_layout();
        break;

    default:
        break;
    }
}

void CWwTitleBar::set_horizontal_layout()
{
    QHBoxLayout *p_layout = new QHBoxLayout(m_p_proxy_widget);

    p_layout->addWidget(m_p_icon);
    p_layout->addWidget(m_p_title_text);
    p_layout->addSpacing(c_titlebar_icon_title_distance);
    p_layout->addStretch();
    p_layout->addWidget(m_p_min);
    p_layout->addWidget(m_p_max_restore);
    p_layout->addWidget(m_p_close);
    m_p_layout = p_layout;
    m_p_layout->setContentsMargins(c_normal_margin);
    m_p_layout->setSpacing(0);
}

void CWwTitleBar::insert_widget_in_hlayout(qint32 index, QWidget *p_widget)
{
    QHBoxLayout *p_layout = qobject_cast<QHBoxLayout *>(m_p_layout);

    if (p_layout != nullptr) {
        p_layout->insertWidget(index, p_widget);
    }
}

void CWwTitleBar::set_vertical_layout()
{
    QVBoxLayout *p_layout = new QVBoxLayout(m_p_proxy_widget);
    QHBoxLayout *p_layout_h = new QHBoxLayout;

    p_layout_h->addWidget(m_p_icon);
    p_layout_h->addWidget(m_p_title_text);
    p_layout_h->addStretch();
    p_layout_h->addWidget(m_p_min);
    p_layout_h->addWidget(m_p_max_restore);
    p_layout_h->addWidget(m_p_close);
    p_layout->addLayout(p_layout_h);
    m_p_layout = p_layout;
    m_p_layout->setContentsMargins(c_normal_margin);
    m_p_layout->setSpacing(0);
}

void CWwTitleBar::insert_widget_in_vlayout(qint32 index, QWidget *p_widget)
{
    QVBoxLayout *p_layout = qobject_cast<QVBoxLayout *>(m_p_layout);

    if (p_layout != nullptr) {
        p_layout->insertWidget(index, p_widget);
    }
}

void CWwTitleBar::on_btn_clicked()
{
    QToolButton *p_btn = qobject_cast<QToolButton *>(sender());
    EWwTitleBarMsg ret = EWwTitleBarMsg::NONE;

    if ((p_btn != nullptr) && (m_p_window != nullptr)) {
        if (p_btn == m_p_min) {
            ret = EWwTitleBarMsg::MIMIMUM_WINDOW;
        } else if (p_btn == m_p_close) {
            ret = EWwTitleBarMsg::CLOSE_WINDOW;
        } else if (p_btn == m_p_max_restore) {
            ret = p_btn->isChecked() ? EWwTitleBarMsg::MAXIMUM_WINDOW : EWwTitleBarMsg::RESTORE_WINDOW;
        }
        if (ret != EWwTitleBarMsg::NONE) {
            emit change_window_state_request_sig(ret);
        }
    }
}

void CWwTitleBar::on_change_window_state(EWwTitleBarMsg msg)
{
    if ((m_p_window != nullptr) && m_p_window->isWindow()) {
        switch (msg) {
        case EWwTitleBarMsg::MIMIMUM_WINDOW:
            m_p_window->showMinimized();
            break;

        case EWwTitleBarMsg::MAXIMUM_WINDOW:
            m_p_window->showMaximized();
            break;

        case EWwTitleBarMsg::RESTORE_WINDOW:
            m_p_window->showNormal();
            break;

        case EWwTitleBarMsg::CLOSE_WINDOW:
            m_p_window->close();
            break;

        default:
            break;
        }
    }
}

bool CWwTitleBar::eventFilter(QObject *p_watched, QEvent *p_event)
{
    bool flag = false;
    QVariant var;

    if ((p_watched == m_p_window) && (m_p_window != nullptr) && (m_p_max_restore != nullptr)) {
        var = m_p_window->property(WwFRAME_MAXSIZE_PROPERTY);
        flag = var.isValid() ? var.toBool() : m_p_window->isMaximized();
        if (p_event->type() == QEvent::Resize) {
            m_p_max_restore->blockSignals(true);
            m_p_max_restore->setChecked(flag);
            m_p_max_restore->blockSignals(false);
        }
        if (m_p_layout != nullptr) {
            m_p_layout->setContentsMargins(flag ? c_max_margin : c_normal_margin);
        }
    }
    return QWidget::eventFilter(p_watched, p_event);
}

```



***mainwindow***

```c++

#pragma once

#include <qmainwindow.h>
#include "ww_titlebar.h"

class CWwMainWindow : public QMainWindow
{
    Q_OBJECT
    ww_FRAME_WIDGET
public:
    explicit CWwMainWindow(QWidget *p_parent = nullptr);
    void setMenuBar(QMenuBar *p_menuBar);
    QMenuBar *menuBar();
    CWwTitleBar *get_titlebar();
private:
    void init_mainwindow();
protected:
    void setMenuWidget(QWidget *p_menuBar);
    bool event(QEvent *event);
};

#include "ww_mainwindow.h"
#include <QStatusBar>
#include <QApplication>

static const QSize c_mainwindow_default_size = QSize(640, 480);

QColor CWwMainWindow::border_color = WwFRAME_WIDGET_BORDER_COLOR;

CWwMainWindow::CWwMainWindow(QWidget *p_parent)
    : QMainWindow(p_parent)
{
    init_mainwindow();
    set_hwnd_options();
}

void CWwMainWindow::setMenuBar(QMenuBar *p_menuBar)
{
    if (m_p_title_bar != nullptr) {
        m_p_title_bar->set_menubar(p_menuBar);
    }
}

QMenuBar *CWwMainWindow::menuBar()
{
    QMenuBar *p_menubar = nullptr;

    if (m_p_title_bar != nullptr) {
        p_menubar = m_p_title_bar->get_menubar();
    }
    return p_menubar;
}

CWwTitleBar *CWwMainWindow::get_titlebar()
{
    return m_p_title_bar;
}

void CWwMainWindow::init_mainwindow()
{
    resize(c_mainwindow_default_size);
    setMenuWidget(m_p_title_bar);
}

void CWwMainWindow::setMenuWidget(QWidget *p_menuBar)
{
    if (p_menuBar != nullptr) {
        m_p_title_bar = qobject_cast<CWwTitleBar *>(p_menuBar);
        QMainWindow::setMenuWidget(m_p_title_bar);
    }
}

bool CWwMainWindow::event(QEvent *event)
{
    if (event->type() == QEvent::ScreenChangeInternal) {
        QSize size_current = size();
        QString qtconf = QApplication::applicationDirPath() + "/qt.conf";
        QSettings setting(qtconf, QSettings::IniFormat);
        QString value = setting.value("Platforms/WindowsArguments").toString();
        if (value.contains("dpiWwareness=0") ||
            qApp->testAttribute(Qt::AA_EnableHighDpiScaling)) {
            resize(QSize(size_current.width() - 1, size_current.height() - 1));
            resize(size_current);
        }
    }
    return QMainWindow::event(event);
}
```



***messagebox***

```c++
#pragma once
#include "ww_dialog.h"
#include <QMessageBox>

class QFrame;
class QLabel;
class QToolButton;
class QDialogButtonBox;
class QAbstractButton;

class CWwMessageBox : public CWwDialog
{
    Q_OBJECT
public:
    explicit CWwMessageBox(QWidget *parent = nullptr);

    static void  about(QWidget *parent, const QString &title, const QString &text);

    static void aboutQt(QWidget *parent, const QString &title = QString());

    static QMessageBox::StandardButton critical(
            QWidget *parent,
            const QString &title,
            const QString &text,
            QMessageBox::StandardButtons buttons = QMessageBox::Ok,
            QMessageBox::StandardButton defaultButton = QMessageBox::NoButton);

    static QMessageBox::StandardButton information(
            QWidget *parent,
            const QString &title, const QString &text,
            QMessageBox::StandardButtons buttons = QMessageBox::Ok,
            QMessageBox::StandardButton defaultButton = QMessageBox::NoButton);

    static QMessageBox::StandardButton question(
            QWidget *parent,
            const QString &title,
            const QString &text,
            QMessageBox::StandardButtons buttons = QMessageBox::StandardButtons(QMessageBox::Yes | QMessageBox::No),
            QMessageBox::StandardButton defaultButton = QMessageBox::NoButton);

    static QMessageBox::StandardButton warning(
            QWidget *parent,
            const QString &title,
            const QString &text,
            QMessageBox::StandardButtons buttons = QMessageBox::Ok,
            QMessageBox::StandardButton defaultButton = QMessageBox::NoButton);

private:
    QFrame *m_p_frame;
    QLabel *m_p_icon;
    QLabel *m_p_msg;
    QDialogButtonBox *m_p_btnbox;
    QMessageBox::StandardButton m_clicked_btn;

    void create_layout();
    void bind_event();
    void set_icon(QMessageBox::Icon icon);
    void set_msg(QString text);
    void set_standard_buttons(QMessageBox::StandardButtons buttons);
    void set_default_button(QMessageBox::StandardButton default_button);
    void on_button_clicked(QAbstractButton *p_btn);
    void disable_titlebar_close_btn();
    bool eventFilter(QObject *watched, QEvent *event);
    void set_messagebox_information(
        QMessageBox::Icon icon,
        const QString &title,
        const QString &text,
        QMessageBox::StandardButtons buttons,
        QMessageBox::StandardButton default_button);
};


#include "ww_messagebox.h"
#include <QFrame>
#include <QLabel>
#include <QDialogButtonBox>
#include <QHBoxLayout>
#include <QVBoxLayout>
#include <QStyle>
#include <QApplication>
#include <QToolButton>
#include <QAbstractButton>
#include <QFontMetrics>

static const qint32 c_msgbox_max_width = 400;
static const qint32 c_msgbox_contents_margin = 50;
static const qint32 c_msgbox_icon_text_space = 5;
static const QSize c_msgbox_icon_size = QSize(40, 40);
static const QSize c_msgbox_titlebar_closebtn_size = QSize(34, 25);
static const QMargins c_msgbox_frame_margin = QMargins(0, 0, 0, 0);
static const QMargins c_msgbox_margin = QMargins(9, 9, 9, 9);

CWwMessageBox::CWwMessageBox(QWidget *parent)
    : CWwDialog(parent),
      m_p_frame(nullptr),
      m_p_icon(nullptr),
      m_p_msg(nullptr),
      m_p_btnbox(nullptr),
      m_clicked_btn(QMessageBox::Cancel)
{
    create_layout();
    bind_event();
}

void CWwMessageBox::set_icon(QMessageBox::Icon icon)
{
    QStyle *p_style = QApplication::style();
    QMap<QMessageBox::Icon, QStyle::StandardPixmap> srcs = {
        {QMessageBox::Information, QStyle::SP_MessageBoxInformation},
        {QMessageBox::Warning, QStyle::SP_MessageBoxWarning},
        {QMessageBox::Critical, QStyle::SP_MessageBoxCritical},
        {QMessageBox::Question, QStyle::SP_MessageBoxQuestion},
    };

    if ((p_style != nullptr) && (m_p_icon != nullptr) && srcs.contains(icon)) {
        QIcon icon_src = p_style->standardIcon(srcs[icon]);
        m_p_icon->setPixmap(icon_src.pixmap(c_msgbox_icon_size));
        m_p_icon->setVisible(!icon_src.isNull());
    }
}

void CWwMessageBox::about(QWidget *parent, const QString &title, const QString &text)
{
    CWwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::NoIcon, title, text, QMessageBox::Ok, QMessageBox::Ok);
    w.exec();
}

void CWwMessageBox::aboutQt(QWidget *parent, const QString &title)
{
    QMessageBox::aboutQt(parent, title);
}

QMessageBox::StandardButton CWwMessageBox::critical(QWidget *parent, const QString &title, const QString &text,
    QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    CWwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::Critical, title, text, buttons, default_button);
    w.exec();
    return w.m_clicked_btn;
}

QMessageBox::StandardButton CWwMessageBox::information(QWidget *parent, const QString &title, const QString &text,
    QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    CWwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::Information, title, text, buttons, default_button);
    w.exec();
    return w.m_clicked_btn;
}

QMessageBox::StandardButton CWwMessageBox::question(QWidget *parent, const QString &title, const QString &text,
    QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    CWwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::Question, title, text, buttons, default_button);
    w.exec();
    return w.m_clicked_btn;
}

QMessageBox::StandardButton CWwMessageBox::warning(QWidget *parent, const QString &title, const QString &text,
    QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    CWwMessageBox w(parent);
    w.set_messagebox_information(QMessageBox::Warning, title, text, buttons, default_button);
    w.exec();
    return w.m_clicked_btn;
}

void CWwMessageBox::create_layout()
{
    QHBoxLayout *p_mainlayout = new QHBoxLayout;
    QVBoxLayout *p_framelayout = new QVBoxLayout;
    QHBoxLayout *p_icon_msg = new QHBoxLayout;

    m_p_frame = new QFrame;
    m_p_icon = new QLabel;
    m_p_msg = new QLabel;
    m_p_btnbox = new QDialogButtonBox;

    m_p_icon->hide();
    m_p_icon->setFixedSize(c_msgbox_icon_size);
    m_p_msg->setWordWrap(true);
    m_p_msg->setSizePolicy(QSizePolicy::Fixed, QSizePolicy::Fixed);

    p_icon_msg->addWidget(m_p_icon);
    p_icon_msg->addWidget(m_p_msg);
    p_icon_msg->setSpacing(c_msgbox_icon_text_space);

    p_framelayout->addLayout(p_icon_msg);
    p_framelayout->addWidget(m_p_btnbox);
    p_framelayout->setContentsMargins(c_msgbox_frame_margin);
    m_p_frame->setLayout(p_framelayout);

    p_mainlayout->addWidget(m_p_frame);
    p_mainlayout->setContentsMargins(c_msgbox_margin);

    setLayout(p_mainlayout);
    disable_titlebar_close_btn();
    setSizePolicy(QSizePolicy::Fixed, QSizePolicy::Fixed);
}

void CWwMessageBox::bind_event()
{
    connect(m_p_btnbox, &QDialogButtonBox::clicked, this, &CWwMessageBox::on_button_clicked);
}

void CWwMessageBox::set_msg(QString text)
{
    if (m_p_msg != nullptr) {
        m_p_msg->setText(text);
        m_p_msg->setMinimumWidth(qMin(c_msgbox_max_width, \
            QFontMetrics(m_p_msg->font()).horizontalAdvance(text) + c_msgbox_contents_margin));
    }
}

void CWwMessageBox::set_standard_buttons(QMessageBox::StandardButtons buttons)
{
    if (m_p_btnbox != nullptr) {
        m_p_btnbox->setStandardButtons(QDialogButtonBox::StandardButtons(static_cast<int>(buttons)));
    }
}

void CWwMessageBox::set_default_button(QMessageBox::StandardButton default_button)
{
    QPushButton *p_default_button = nullptr;

    if (m_p_btnbox != nullptr) {
        p_default_button = m_p_btnbox->button(QDialogButtonBox::StandardButton(default_button));
    }
    if (p_default_button != nullptr) {
        p_default_button->setDefault(true);
    }
}

void CWwMessageBox::set_messagebox_information(
        QMessageBox::Icon icon, const QString &title, const QString &text,
        QMessageBox::StandardButtons buttons, QMessageBox::StandardButton default_button)
{
    installEventFilter(this);
    setWindowTitle(title);
    set_standard_buttons(buttons);
    set_default_button(default_button);
    set_icon(icon);
    set_msg(text);
}

void CWwMessageBox::on_button_clicked(QAbstractButton *p_btn)
{
    if (m_p_btnbox != nullptr) {
        m_clicked_btn = QMessageBox::StandardButton(m_p_btnbox->standardButton(p_btn));
        done(m_clicked_btn);
    }
}

void CWwMessageBox::disable_titlebar_close_btn()
{
    CWwTitleBar *p_titlebar = get_titlebar();
    QToolButton *p_titlebar_close = nullptr;

    if (p_titlebar != nullptr) {
        p_titlebar_close = p_titlebar->get_close_btn();
        if (p_titlebar_close != nullptr) {
            p_titlebar_close->setEnabled(false);
            p_titlebar_close->setFixedSize(c_msgbox_titlebar_closebtn_size);
        }
    }
}

bool CWwMessageBox::eventFilter(QObject *watched, QEvent *event)
{
    if (event->type() == QEvent::Resize) {
        return true;
    }
    return CWwDialog::eventFilter(watched, event);
}

```



***dialog***

```c++

#pragma once
#include "ww_titlebar.h"
#include <QDialog>

class QVBoxLayout;

class CWwDialog : public QDialog
{
    Q_OBJECT
    ww_FRAME_WIDGET
public:
    explicit CWwDialog(QWidget *p_parent = nullptr);
    void setLayout(QLayout *p_layout);
    CWwTitleBar *get_titlebar();
private:
    QVBoxLayout *m_p_layout;
    QWidget *m_p_center_widget;
    void init_dialog();
    void init_layout();
protected:
    bool event(QEvent *event);
};

#include "ww_dialog.h"
#include <QVBoxLayout>

static const QSize c_dialog_default_size = QSize(640, 480);

QColor CWwDialog::border_color = WwFRAME_WIDGET_BORDER_COLOR;

CWwDialog::CWwDialog(QWidget *p_parent)
    : QDialog(p_parent),
      m_p_layout(nullptr),
      m_p_center_widget(nullptr)
{
    init_dialog();
    set_hwnd_options();
}

void CWwDialog::setLayout(QLayout *p_layout)
{
    if (m_p_center_widget != nullptr) {
        m_p_center_widget->setLayout(p_layout);
    }
}

CWwTitleBar *CWwDialog::get_titlebar()
{
    return m_p_title_bar;
}

void CWwDialog::init_dialog()
{
    init_layout();
}

void CWwDialog::init_layout()
{
    m_p_layout = new QVBoxLayout(this);
    m_p_center_widget = new QWidget;
    m_p_layout->setContentsMargins(0, 0, 0, 0);
    m_p_layout->setSpacing(0);
    m_p_layout->addWidget(m_p_title_bar);
    m_p_layout->addWidget(m_p_center_widget);
    if (m_p_title_bar != nullptr) {
        m_p_title_bar->hide_min_maxrestore();
        m_p_title_bar->setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Maximum);
    }
    resize(c_dialog_default_size);
}

bool CWwDialog::event(QEvent *event)
{
    if (event->type() == QEvent::ScreenChangeInternal) {
        QSize size_current = size();
        QString qtconf = QApplication::applicationDirPath() + "/qt.conf";
        QSettings setting(qtconf, QSettings::IniFormat);
        QString value = setting.value("Platforms/WindowsArguments").toString();
        if (value.contains("dpiWwareness=0") ||
            qApp->testAttribute(Qt::AA_EnableHighDpiScaling)) {
            resize(QSize(size_current.width() - 1, size_current.height() - 1));
            resize(size_current);
        }
    }
    return QDialog::event(event);
}
```

