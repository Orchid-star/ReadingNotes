# 第1章 导论

**概述**

操作系统是硬件与用户之间的中介程序，**目的**是为用户提供方便且有效地执行程序的环境。

操作系统每一部分都是构造好的系统的一部分，并严格定义了**输入、输出和功能**。

## 1.1 操作系统做什么

计算机系统分为硬件和软件，软件包括操作系统、系统程序、应用程序。

操作系统本身并不能实现任何有用的功能，**只不过**提供了一个方便其他程序做有用工作的环境。

### 1.1.1 用户视角

不同的使用情况强调不同的用户观点。

### 1.1.2 系统视角

操作系统是控制程序，控制程序管理用户程序的执行以防止计算机资源的错误或不当使用。特别关注I/O设备的操作和控制。

### 1.1.3 定义操作系统

计算机系统的基本目的是执行用户程序并能更容易地解决用户问题（图灵机模型）。

不同的应用程序，共同的控制和分配I/O设备资源的功能集合组成了一个软件模块----操作系统。

操作系统是一直运行在计算机上的程序（通常称为**内核**），其他程序则称为系统程序和应用程序。

## 1.2 计算机系统组织

### 1.2.1 计算机系统操作

现代计算机系统如图：

<img src="./images/uint1/现代计算机系统.png" style="zoom:40%;" />



**启动**

首先运行**引导程序**（booststrap program, 位于ROM中）。引导程序是计算机硬件中的固件，用于初始化系统的所有部分，包括CPU寄存器、设备控制器和内存内容。

然后，引导程序定位操作系统内核并将其装入内存，开始执行系统。

最后，操作系统开始执行第一个进程如init，并等待事件的发生。



**中断**

硬件和软件都能触发中断，用于表示事件的发生。

CPU中断发生时，CPU暂停正在做的事并转移到**中断服务程序**的首地址开始执行中断服务程序。



### 1.2.2 存储结构

设备存储层次如下图：

<img src="./images/uint1/设备存储层次.png" style="zoom:67%;" />

一个典型指令执行周期首先从内存中获取指令，并保存到**指令寄存器**，然后对指令解码，并可能导致从内存中获取操作数或将操作数保存在内部寄存器中。在指令完成对操作数的执行后，其结果可以存回到内存。



### 1.2.3 I/O结构

存储器只是众多I/O设备的一种。

通用计算机系统由一个CPU和多个**设备控制器**组成，他们通过共同的总线连接起来。每个设备控制器负责特定类型的设备，可有多个设备与其相连。



**设备控制器**

设备控制器维护一定量的**本地缓冲存储**和一组**特定用途的寄存器**。设备控制器控制其其负责的外部设备与本次缓冲存储之间的数据传递。操作系统为每个设备控制器提供一个设备驱动程序。



**设备驱动层序**

设备驱动层序理解设备控制器，并提供设备与操作系统的统一接口。

为了开始I/O操作，设备驱动程序在设备控制器中装载适当的寄存器，设备控制器检查这些寄存器的内容以决定采取什么操作。然后控制器开始从所管理的设备向本地缓冲区传输数据，完成后通过中断通知设备驱动程序其已完成操作。然后设备驱动程序返回对操作系统的控制，如返回数据或数据指针，或状态信息。

I/O中断驱动适合移动少量数据。DMA（直接内存访问）适合大块数据移动。DMA中，设备控制器能在本地缓冲和内存之间传送一整块数据而无需CPU的干预。



## 1.3 计算机体系结构

计算机可以通过许多不同的途径组织，例如可以大致通过处理器数量来分类。

### 1.3.1 单处理器系统

单处理器系统中，有**一个主CPU**能够执行一个通用指令集，包括来自于用户进程的指令。绝大多数系统还包括其他特定目的的处理器，以**专用设备处理器**（如磁盘、键盘、图形控制器）的形式出现。专用处理器运行一个受限的指令集，并不允许用户进程，由操作系统管理。

如果只有一个通用CPU，系统则为单处理系统。

### 1.3.2 多处理器系统

多处理器系统（也称并行系统或紧耦合系统）有多个紧密通信的CPU，他们共享计算机总线，有时还包括时钟、内存、外设等。

优点：增加吞吐量，规模经济，增加可靠性。

CPU的设计趋势是将多个计算机**内核（core)**设计到单个芯片上，他们实际上是多处理器芯片。

### 1.3.3 集群系统



## 1.4 操作系统结构

**操作系统最重要的一点**

多道程序处理能力

多道程序的设计使CPU总有一个作业可执行。只要有一个任务可以执行，CPU就决不会空闲，从而提高了CPU的利用率。

操作系统将多个任务（称为**作业集**）保存在内存中。作业集是作业池的子集。

<img src="./images/uint1/多道程序系统的内存分布.png" style="zoom:50%;" />

**分时系统（或多任务）**是多道程序设计的延伸。虽然CPU还是通过作业之间的切换来执行作业，但是由于切换频率很高，用户可以在程序运行期间与之交互。

分时操作系统允许许多用户同时共享计算机。

装入到内存中的程序通常称为**进程（process)**。

**作业池**：由于主存较小，作业开始都被存放在磁盘上，该存储位置称为作业池。

**作业调度**：多个作业需要调入内存但没有足够的内存，系统必须在这些作业中做选择的决策称为作业调度。

**CPU调度**：多个任务同时需要进行，系统如何做出选择，称为cpu调度。



分时操作系统可通过**交换**保证合理的响应时间。交换时进程被换入内存或由内存换出到磁盘。





## 1.5 操作系统操作

现代操作系统由中断驱动。事件总是由中断或陷阱引起。**陷阱**或**异常**是一种软件中断，源于出错（如除数为0或无效的内存访问），或源于用户程序的特别请求（完成操作系统服务）。

**中断服务程序**是系统的一部分，用于处理中断。

操作系统的合理设计必须确保错误程序（或恶意程序）不会造成其他程序执行错误。

### 1.5.1 双重模式操作

通过硬件支持，使用**内核模式**和**用户模式**区分系统程序和用户程序，以确保操作系统的正常执行。

计算机硬件中的**模式位**表示当前模式。用户程序执行时，系统处于用户模式；系统程序执行时，系统处于内核模式。当用户程序通过**系统调用**的方式需要操作系统的服务时，也会先从用户模式切换到内核模式来执行相关请求。

<img src="./images/uint1/用户模式到内核模式的转换.png" style="zoom:50%;" />

用户模式下，一旦出现陷阱或中断，硬件会从用户模式切换到内核模式，操作系统获得对计算机的控制。

双重模式操作提供了一种手段，该手段对操作系统和其他正常进行的用户程序提供了保护，免于受错误用户程序的影响。

**特权指令（privileged instruction）**是能够引起损害的机器指令。如果用户模式下试图执行特权指令，硬件会认为该指令非法且不执行，并通过陷阱通知操作系统。

**系统调用**是一种进程请求操作系统执行动作的方法。执行系统调用时，硬件会将其作为软件中断，控制权会通过中断向量转交到操作系统的中断处理程序。操作系统分析并执行请求后，将控制权返回系统调用之后的指令。

只要一个程序出现错误，操作系统就必须对它进行异常终止。

### 1.5.2 定时器

**定时器**用于防止用户程序陷入死循环或不调用系统服务，并且不讲控制权返回到操作系统。到达定时器指定的时间，则触发中断，操作系统可将中断作为致命错误来处理，也可以给予用户更多的时间。修改定时器的操作属于特权指令。

## 1.6 进程管理





## 1.7 内存管理



## 1.8 存储管理

### 1.8.1 文件系统管理



### 1.8.2 大容量存储器管理



### 1.8.3 高速缓存



### 1.8.4 I/O系统



## 1.9 保护和安全



## 1.10 分布式系统



## 1.11 专用系统

### 1.11.1 实时嵌入式系统



### 1.11.2 多媒体系统



### 1.11.3 手持系统



## 1.12 计算环境

### 1.12.1 传统计算



### 1.12.2 客户机-服务器计算



### 1.12.3 对等计算



### 1.12.4 基于Web的计算











