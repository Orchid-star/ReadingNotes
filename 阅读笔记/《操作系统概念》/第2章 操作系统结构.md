



# 第2章 操作系统结构

操作系统可以有很多种组织方式。设计系统时，系统的类型决定了如何选择算法和策略。

研究操作系统的角度：

- 操作系统提供的服务
- 操作系统为用户和程序员提供的接口
- 系统的各个组成部分及其相互关系

## 2.1 操作系统服务

**操作系统服务**方便了程序员，使得编程更加容易。

操作系统服务对用户提供很有用的函数：

- **用户界面**：所有的操作系统都有**用户界面**（UI）。用户界面的形式有：（1）**命令行界面**CLI，采用文本命令 （2）**批界面**：如图形用户界面（graphical user interface, GUI）
- **程序执行**：将程序装入内存并运行程序。
- **I/O操作**：提供I/O操作的方法，可能设计文件或设备。
- **文件系统操作**：读写文件和目录。创建、删除、搜索文件，或显示文件信息等。
- **通信**：一个进程与另一个进程交换信息。形式包括：第一种同一台计算机的两个进程之间；第二章由网络连接起来的不同的计算机上的进程之间。
- **错误检测**：对于各种可能的硬件以及程序上的错误，操作系统应该采取适当的动作以确保正确和一致的计算。
- **资源分配**：有的资源（如CPU周期、内存和文件存储）需要特别的分配代码，其他资源（如I/O设备）可能只需要通用的请求和释放代码）
- **统计**：哪些用户使用了多少和什么类型的资源。
- **保护和安全**：多个进程并发执行时相互不受影响；不受外界侵犯。





## 2.2 操作系统的用户界面

### 2.2.1 命令解释程序

有的操作系统内核部分包含**命令解释程序**。在具有多个命令解释程序的系统中，解释程序被称为**外壳Shell**，例如Linux系统中，有多种不同夫人shell可供用户选择。许多用户对shell的选择只是基于个人偏好。

**Shell的主要作用**：获取并执行用户指定的程序。

**Shell执行命令的两种常用方法**：

- 命令解释程序本身包含代码以执行这些命令：所能提供的命令的数量决定了解释程序的大小，因为每个程序需要自己实现。
- 由系统程序实现绝大多数命令：只要用命令来识别文件以装入内存并执行，如rm file.txt，会搜索名为rm的文件，并用参数file.txt来执行



### 2.2.2 图形用户界面

GUI允许提供基于鼠标的窗口和菜单系统作为接口。根据鼠标的位置，按一下鼠标按钮就可以调用程序、选择文件目录、文件、目录和系统功能。



## 2.3 系统调用

**系统调用（system call)**提供了操作系统操作系统的有效服务界面。这些调用通常用C或C++编写，对底层的任务可能以汇编指令的形式提供。（是不是可以理解系统调用就是程序接口？）

**操作系统如何使其系统调用可用？**

文件创建、读写、复制、删除等等都是系统调用，一般系统每秒钟会执行数千个系统调用。

一般应用程序开发人员根据**应用程序接口（API）**设计程序。API是一系列适用于应用程序员的函数，包括传递给每个函数的参数及返回的程序员想得到的值。

三种应用程序员常用的API，分别是适用于Windows系统的Win32 API，适用于POSIX系统的POSIX API(包括所有UNIX、Linux和Mac OS X系统)，用于设计运行于Java虚拟机程序的Java API.



**API**通常为应用程序员调用实际的系统调用。如：CreateProcess()实际调用Windows内核中的NTCreateProcess()系统调用。

**为什么程序员使用API编程，不调用实际的系统调用？**

使用API的可移植性好，且系统调用更为注意细节，使用更困难。

（系统调用是内核提供的接口？）



## 2.4 系统调用类型

系统调用大致分为5类

- **进程控制**
- **文件管理**
- **设备管理**
- **信息维护**
- **通信**

<img src="./images/uint2/系统调用类型.png" style="zoom:50%;" />

### 2.4.1 进程控制

程序需要能够正常中断（end)或非正常中断（abort)。

![](./images/uint2/write()的C库函数处理.png)

### 2.4.2 文件管理

文件创建、删除、打开、关闭、读写、重定位、属性获取与设置等。

### 2.4.3 设备管理

程序向系统申请资源，如果资源满足，系统会将对资源的控制返回到用户程序；否则程序必须等待足够多的资源。

不同的资源指的是不同的设备，包括物理设备，以及抽象或虚拟的设备（如文件）。

使用完设备，用户需要释放，类似文件的打开与关闭（open和close)的系统调用。

**I/O设备和文件非常相似**，可以对设备进行读、写或重定位，以至于许多操作系统如unix将两者合并为文件-设备结构。

### 2.4.4 信息维护

许多系统调用用于用户程序与操作系统之间传递信息，即进行信息维护。如有系统调用用于返回当前的时间和日期，当前用户数，操作系统的版本，空闲内存，磁盘的多少，所有的进程信息等。

### 2.4.5 通信

两种通信模型

- **消息传递模型**  通信进程之间通过交换消息进行通信。每个进程都有进程名，通常转换成标识符一边操作系统引用。通信源被称为**客户机**，接收方被称为**服务器**。
- **共享内存模型**  进程使用shared memory create和shared memory attach系统调用来获取其他进程所拥有的内存区域的访问权。**线程**是进程模型的变形，一般他们共享内存。**共享内存允许最大速度通信且十分方便，但在保护和同步方面，进程共享内存存在一些问题。**



## 2.5 系统程序

**计算机的逻辑层次**

硬件 --- 操作系统 --- 系统程序 --- 应用程序。

系统程序提供了一个方便的环境，辅助开发程序以及执行程序。

小部分系统程序是系统调用的简单接口，其他可能非常复杂。

**系统程序分类**：

- **文件管理**  与文件管理相关的系统程序用于创建、删除、复制、重新命名、打印、转储、列出操作文件和目录。
- **状态信息**  与状态信息有关的程序从操作系统获得日期、时间、可用内存、磁盘空间数量、用户数或类似状态信息，除此之外还包括纤细的性能、登录和调试信息。有的系统支持**注册表**，用于存储和检索配置信息。
- **文件修改**  如编辑器可以创建和修改文件内容。特殊的命令被用于查找文件内容或完成文本的转换。
- **程序语言支持**  与程序语言支持相关的系统程序，包括编译程序、汇编程序、调试程序和解释程序通常与操作系统一起提供给用户。
- **程序装入和执行**  系统可能提供系统程序，如绝对加载程序、重定位加载程序、连接编辑器、覆盖式加载程序等，用于将程序装入内存并执行。还包括高级语言或机器语言的调试程序。
- **通信**  与通信有关的系统程序提供了在进程、用户和计算机系统之间创建虚拟连接的机制。

**系统工具或应用程序**

除系统程序外，操作系统还提供**系统工具或应用程序**以解决一般问题和执行一般操作，如网页浏览器、字处理器、文本格式化器、电子制表软件、数据库系统、编译器、打印和统计分析包，以及游戏等。



**绝大多数用户看到的操作系统是由应用程序和系统程序而不是系统调用所决定的。**



## 2.6 操作系统设计和实现

### 2.6.1 设计目标



### 2.6.2 机制与策略



### 2.6.3 实现



## 2.7 操作系统结构

### 2.7.1 简单结构



### 2.7.2 分层方法



### 2.7.3 微内核



### 2.7.4 模块



## 2.8 虚拟机

### 2.8.1 实现



### 2.8.2 优点



### 2.8.3 实例



## 2.9 系统生成



## 2.10 系统启动



