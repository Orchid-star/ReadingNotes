# TCP报文格式解析

TCP报文是TCP层传输的数据单元，也称报文段。每个字段如下：

![](./images/uint5/TCP报文格式.png)

**源端口和目的端口字段**

- TCP源端口（Source Port）:源计算机上的硬凑程序端口号，占16位
- TCP目的端口（Destination Port）:目标计算机的应用程序端口号，占16位

**序列号字段**

CP序列号（Sequence Number）:占32位，表示本报文段所发送的数据第一个字节的编号。在TCP连接中，所传送的字节流的每一个字节都会按顺序编号。当SYN标记不为1时，这是当前数据分段第一个字母的序列号；如果SYN为1，这个字段的值就是初始序列值（ISN），用于对序列号进行同步。这时第一个字节的序列号比这个字段的值大1，也就是ISN加1。

**确认号字段**

TCP确认号（Acknowledgement Number, ACK number）:占32位。它表示接收方期望收到发送方下一个报文段的第一个字节数据的编号。其值是接收计算机即将接收到的下一个序列号，也就是下一个接收到的字节的序列号加1。

**数据偏移字段**

TCP首部长度（Header Length）:占4位。确定TCP数据段头部的长度，告诉接收端的应用程序，数据从何处开始

**保留字段**

保留（Reserved）：占4位。为TCP将来的发展预留空间，目前必须全部为0.

**标志位字段**

- **CWR(COngestion WIndow Reduce):**拥塞窗口减少标志，用来表明它接收到了设置ECE标志的TCP包，并且发送方收到消息之后，通过减小发送窗口的大小来降低发送速率。
- **ECE(ECN Echo):**用来在TCP三次握手时表明一个TCP端是具备ECN功能的。在数据传输过程中，它也用来表明接收到的TCP包的IP头部的ECN被设置为11，即网络线路拥堵。
- **URG(Urgent):**表示本报文段发送的数据是否包含紧急数据。URG=1时表示有紧急数据，后面的紧急指针字段才有效。
- **ACK:**表示前面的确认号字段是否有效。ACK=1表示有效。TCP规定，连接建立后，ACK必须为1
- **PSH(Push):**告诉对方收到该报文段后是否立即把数据推送给上层。如果为1，立即把数据提交给上层，而不是缓存起来。
- **RST:**表示是否重置连接。如果RST=1，说明TCP连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接。
- **SYN:**在建立连接时使用，用来同步序号。当SYN=1,ACK=0时，表示这是一个请求建立连接的报文段；当SYN=1,ACK=1时，表示对方同意建立连接。当SYN=1时，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中SYN才为1.
- **FIN:**标记数据是否发送完毕。如果FIN=1,表示数据发送完成，可以释放连接。

**窗口大小字段**

窗口大小（Window Size:）:占16位。它表示从Ack Number开始还可以接收多少字节的数据量，也表示当前接收端的接收窗口还有多少剩余空间。该字段可以用于TCP的流量控制。

**TCP校验和字段**

校验位（TCP Checksum）:占16位。用于确认传输的数据是否有损坏。发送端基于数据内容校验生成一个数值，接收端根据接收的数据校验生成一个值。两个值必须相同，才能证明数据是有效的。如果两个值不同，则丢掉这个数据包。Checksum是根据伪头+TCP头+TCP数据三部分进行计算的

**紧急指针字段**

紧急指针（Urgent Pointer）:仅当前面的URG控制位为1时才有意义。它指出本数据段中紧急数据的字节数，占16位。当所有紧急数据处理完成后，TCP就会告诉应用程序恢复到正常操作。即使当前窗口大小为0，也是可以发送紧急数据的，因为紧急数据无需缓存。

**可选项字段**

选项（Option)：长度不定，但长度必须是32bits的整数倍。